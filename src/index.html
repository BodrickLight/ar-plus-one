<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ArPlusOne</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1976d2">

  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script>
    AFRAME.registerComponent('moving-poi', {
      init: function() {
        this.directionVec = new THREE.Vector3();
      },
      schema: {
        x: {
          type: 'number'
        },
        y: {
          type: 'number',
        },
        z: {
          type: 'number',
        },
        xSpeed: {
          type: 'number',
        },
        ySpeed: {
          type: 'number',
        },
        zSpeed: {
          type: 'number',
        }
      },
      update: function() {
        this.el.setAttribute('position', {
            x: this.data.x,
            y: this.data.y,
            z: this.data.z
        });
        this.directionVec.set(this.data.xSpeed, this.data.ySpeed, this.data.zSpeed);
      },
      tick: function(time, timeDelta) {
        if (!this.t0) {
          this.t0 = time;
        }
        var dt = (time - this.t0) / 1000;
        var velocity = this.directionVec;

        this.el.setAttribute('position', {
            x: this.data.x + velocity.x * dt,
            y: this.data.y + velocity.y * dt,
            z: this.data.z + velocity.z * dt
        });
      }
    })
  </script>

  <script>
    function loadPlaces(position) {
    const endpoint = `https://opensky-network.org/api/states/all
?lamax=${position.latitude + 0.2}
&lamin=${position.latitude - 0.2}
&lomax=${position.longitude + 0.4}
&lomin=${position.longitude - 0.4}`;
    return fetch(endpoint, {
      timeout: 5000
    })
        .then((res) => {
            return res.json()
                .then((resp) => {
                    return resp.states;
                })
        })
        .catch((err) => {
            console.error('Error with opensky API', err);
        })
        
};


window.onload = () => {
  reloadData();
}
function reloadData() {
    const scene = document.querySelector('a-scene');
    const gps = document.querySelector("a-camera").components['gps-projected-camera'];

    // first get current user location
    return navigator.geolocation.getCurrentPosition(function (position) {

        // than use it to load from remote APIs some places nearby
        loadPlaces(position.coords)
            .then((places) => {
                const elements = scene.querySelectorAll('a-link');
                for (let e of elements) {
                  scene.removeChild(e);
                }
                places.forEach((place) => {
                  const time = place[3];
                  if (!time) {
                    return;
                  }

                  const initialOffset = new Date().getTime() / 1000 - time;
                  const id = place[0];
                    const latitude = place[6];
                    const longitude = place[5];
                    const velocity = place[9];
                    const heading = place[10] - 90;// + 180; //place[10];

                    const worldPosition = gps.latLonToWorld(latitude, longitude);
                    const x0 = worldPosition[0];
                    const y0 = place[7];
                    const z0 = worldPosition[1];

                    if (y0 < 1000) {
                      return;
                    }

                    const xSpeed = velocity * Math.cos(heading * Math.PI / 180);
                    const ySpeed = place[11];
                    const zSpeed = velocity * Math.sin(heading * Math.PI / 180);

                    const x = x0 + xSpeed * initialOffset;
                    const y = y0 + ySpeed * initialOffset;
                    const z = z0 + zSpeed * initialOffset;

                    element = document.createElement('a-link');
                    element.setAttribute('moving-poi', `x: ${x}; y: ${y}; z: ${z}; xSpeed: ${xSpeed}; ySpeed: ${ySpeed}; zSpeed: ${zSpeed};`);
                    element.setAttribute('title', place[1]);
                    element.setAttribute('scale', '150 150 150');
                    element.setAttribute('id', id);
                    element.setAttribute('look-at', '[gps-projected-camera]');
                    element.addEventListener('loaded', () => {
                        window.dispatchEvent(new CustomEvent('gps-entity-place-loaded'))
                    });

                    scene.appendChild(element);
                  });
                window.setTimeout(() => reloadData(), 10000);
            })
    },
        (err) => console.error('Error in retrieving position', err),
        {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 27000,
        }
    );
};
  </script>
</head>
<body>
  <app-root></app-root>
  <noscript>Please enable JavaScript to continue using this application.</noscript>
</body>
</html>
